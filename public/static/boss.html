<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0">
    <title>Boss Dashboard - The Renoir Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/static/renoir-logo-light.png">
    <style>
        html, body {
            width: 100%;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        /* Force containers to always fill viewport width */
        .container {
            max-width: 100% !important;
            width: 100% !important;
        }
        
        .renoir-green { background-color: #7CB342; }
        .renoir-green-hover:hover { background-color: #689F38; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-gray-900 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="/static/renoir-logo-dark.png" alt="Renoir Consulting" class="h-10">
                <div>
                    <h1 class="text-2xl font-bold">The Renoir Academy</h1>
                    <p class="text-sm text-gray-300">Boss Dashboard</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="showProfileModal()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded transition-colors">
                    <i class="fas fa-user mr-2"></i><span id="user-name"></span>
                </button>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Tabs -->
        <div class="flex space-x-2 mb-6 border-b border-gray-300">
            <button onclick="showTab('signoffs')" class="tab-btn px-6 py-3 font-semibold border-b-4 transition-colors" data-tab="signoffs" style="color: #7CB342; border-color: #7CB342;">
                <i class="fas fa-clipboard-check mr-2"></i>
                Sign-off Requests
                <span id="pending-badge" class="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full">0</span>
            </button>
            <button onclick="showTab('team')" class="tab-btn px-6 py-3 font-semibold border-b-4 border-transparent text-gray-600 hover:text-gray-900 transition-colors" data-tab="team">
                <i class="fas fa-users mr-2"></i>Team Progress
            </button>
            <button onclick="showTab('analytics')" class="tab-btn px-6 py-3 font-semibold border-b-4 border-transparent text-gray-600 hover:text-gray-900 transition-colors" data-tab="analytics">
                <i class="fas fa-chart-line mr-2"></i>Analytics
            </button>
        </div>

        <!-- Sign-offs Tab -->
        <div id="signoffs-tab" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Pending Requests -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-hourglass-half text-yellow-500 mr-2"></i>
                        Pending Sign-offs
                    </h2>
                    <div id="pending-signoffs"></div>
                </div>

                <!-- Recent Decisions -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        <i class="fas fa-history text-gray-500 mr-2"></i>
                        Recent Decisions
                    </h2>
                    <div id="recent-signoffs"></div>
                </div>
            </div>
        </div>

        <!-- Team Tab -->
        <div id="team-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Your Team</h2>
                    <div class="relative">
                        <button onclick="toggleExportMenu()" class="renoir-green renoir-green-hover text-white px-4 py-2 rounded transition-colors">
                            <i class="fas fa-download mr-2"></i>Export Report
                            <i class="fas fa-chevron-down ml-2"></i>
                        </button>
                        <div id="export-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200 z-10">
                            <button onclick="exportReport('csv')" class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-t-lg">
                                <i class="fas fa-file-csv mr-2 text-green-600"></i>Export as CSV
                            </button>
                            <button onclick="exportReport('excel')" class="w-full text-left px-4 py-2 hover:bg-gray-100">
                                <i class="fas fa-file-excel mr-2 text-green-700"></i>Export as Excel
                            </button>
                            <button onclick="exportReport('pdf')" class="w-full text-left px-4 py-2 hover:bg-gray-100 rounded-b-lg">
                                <i class="fas fa-file-pdf mr-2 text-red-600"></i>Export as PDF
                            </button>
                        </div>
                    </div>
                </div>
                <div id="team-list"></div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Team Overview -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Team Overview</h3>
                    <div id="team-stats"></div>
                </div>

                <!-- Level Completion -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4">Level Completion</h3>
                    <div id="level-completion"></div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4">Recent Activity</h3>
                <div id="recent-activity"></div>
            </div>
        </div>
    </div>

    <!-- Sign-off Review Modal -->
    <div id="review-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-3xl w-full max-h-screen overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4">Review Sign-off Request</h3>
            <div id="review-content"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || (user.role !== 'boss' && user.role !== 'admin')) {
            window.location.href = '/';
        }

        document.getElementById('user-name').textContent = user.name;
        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }
        
        function showProfileModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                    <div class="border-b px-6 py-4 flex justify-between items-center">
                        <h2 class="text-2xl font-bold">Profile Settings</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <div class="p-6">
                        <!-- User Info -->
                        <div class="mb-6 pb-6 border-b">
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Name</label>
                                <p class="text-lg">${user.name}</p>
                            </div>
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                                <p class="text-lg">${user.email}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Role</label>
                                <p class="text-lg capitalize">${user.role}</p>
                            </div>
                        </div>
                        
                        <!-- Change Password -->
                        <div>
                            <h3 class="text-lg font-bold mb-4">Change Password</h3>
                            <form id="change-password-form" onsubmit="changePassword(event)">
                                <div class="mb-4">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Current Password *
                                    </label>
                                    <input type="password" id="current-password" required
                                           class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        New Password * (min 6 characters)
                                    </label>
                                    <input type="password" id="new-password" required minlength="6"
                                           class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Confirm New Password *
                                    </label>
                                    <input type="password" id="confirm-password" required minlength="6"
                                           class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-green-500">
                                </div>
                                <div id="password-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
                                <div id="password-success" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>
                                <button type="submit" class="w-full renoir-green renoir-green-hover text-white px-4 py-2 rounded transition-colors">
                                    <i class="fas fa-key mr-2"></i>Change Password
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function changePassword(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorDiv = document.getElementById('password-error');
            const successDiv = document.getElementById('password-success');
            
            // Hide previous messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Validate
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'New passwords do not match';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                await axios.post('/api/auth/change-password', {
                    currentPassword,
                    newPassword
                });
                
                successDiv.textContent = 'Password changed successfully!';
                successDiv.classList.remove('hidden');
                
                // Clear form
                document.getElementById('change-password-form').reset();
                
                // Close modal after 2 seconds
                setTimeout(() => {
                    document.querySelector('.fixed.inset-0').remove();
                }, 2000);
            } catch (error) {
                errorDiv.textContent = error.response?.data?.error || 'Error changing password';
                errorDiv.classList.remove('hidden');
            }
        }

        function showTab(tab) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            
            // Reset all tab buttons to inactive state
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.style.borderColor = 'transparent';
                el.style.color = '#4B5563'; // gray-600
                el.classList.remove('text-green-700');
                el.classList.add('text-gray-600');
            });
            
            // Show selected tab content
            document.getElementById(tab + '-tab').classList.remove('hidden');
            
            // Highlight active tab button with Renoir green
            const activeBtn = document.querySelector(`[data-tab="${tab}"]`);
            if (activeBtn) {
                activeBtn.style.borderColor = '#7CB342'; // Renoir green
                activeBtn.style.color = '#7CB342'; // Renoir green
                activeBtn.classList.remove('text-gray-600');
                activeBtn.classList.add('text-green-700');
            }

            // Load tab data
            if (tab === 'signoffs') loadSignoffs();
            if (tab === 'team') loadTeam();
            if (tab === 'analytics') loadAnalytics();
        }

        async function loadSignoffs() {
            try {
                const [pendingRes, allRes] = await Promise.all([
                    axios.get('/api/boss/signoff-requests'),
                    axios.get('/api/boss/signoff-requests/all')
                ]);
                
                const pending = pendingRes.data.requests;
                const all = allRes.data.requests;
                
                // Update badge
                document.getElementById('pending-badge').textContent = pending.length;
                
                // Pending sign-offs
                document.getElementById('pending-signoffs').innerHTML = pending.length > 0 ?
                    pending.map(req => `
                        <div class="border-l-4 border-yellow-500 bg-yellow-50 p-4 mb-4 rounded">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="font-bold text-lg">${req.consultant_name}</p>
                                    <p class="text-sm text-gray-600">${req.level_title}</p>
                                </div>
                                <span class="text-xs text-gray-500">${new Date(req.requested_at).toLocaleDateString()}</span>
                            </div>
                            <p class="text-sm mb-3">${req.evidence_notes || 'No notes provided'}</p>
                            ${req.evidence_url ? `<a href="${req.evidence_url}" target="_blank" class="text-sm text-green-700 hover:underline mb-3 block"><i class="fas fa-link mr-1"></i>View Evidence</a>` : ''}
                            <button onclick="reviewSignoff(${req.id})" class="renoir-green renoir-green-hover text-white px-4 py-2 rounded text-sm w-full">
                                <i class="fas fa-eye mr-2"></i>Review
                            </button>
                        </div>
                    `).join('') : '<p class="text-gray-500">No pending sign-off requests</p>';
                
                // Recent decisions
                const recent = all.filter(r => r.status !== 'pending').slice(0, 10);
                document.getElementById('recent-signoffs').innerHTML = recent.length > 0 ?
                    recent.map(req => `
                        <div class="border-l-4 ${req.status === 'approved' ? 'border-green-500' : 'border-red-500'} p-4 mb-4 rounded">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold">${req.consultant_name}</p>
                                    <p class="text-sm text-gray-600">${req.level_title}</p>
                                    <p class="text-xs text-gray-500 mt-1">${new Date(req.reviewed_at).toLocaleDateString()}</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded ${req.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${req.status.toUpperCase()}
                                </span>
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-500">No recent decisions</p>';
            } catch (error) {
                console.error('Error loading sign-offs:', error);
            }
        }

        async function reviewSignoff(requestId) {
            try {
                const response = await axios.get(`/api/boss/signoff-requests/${requestId}`);
                const { request, tasks, testPerformance } = response.data;
                
                const html = `
                    <div class="mb-6">
                        <h4 class="text-xl font-bold mb-2">${request.consultant_name}</h4>
                        <h5 class="text-lg text-gray-700 mb-4">${request.level_title}</h5>
                        <p class="text-sm text-gray-600 mb-4">${request.level_description || ''}</p>
                    </div>

                    <div class="mb-6">
                        <h4 class="font-bold mb-2">Boss Level Tasks:</h4>
                        <ul class="list-disc list-inside space-y-1">
                            ${tasks.map(t => `<li>${t.task_description}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="mb-6">
                        <h4 class="font-bold mb-2">Evidence Provided:</h4>
                        <p class="text-sm bg-gray-50 p-3 rounded">${request.evidence_notes || 'No notes provided'}</p>
                        ${request.evidence_url ? `<a href="${request.evidence_url}" target="_blank" class="text-green-700 hover:underline text-sm mt-2 block"><i class="fas fa-link mr-1"></i>View Evidence</a>` : ''}
                    </div>

                    <div class="mb-6">
                        <h4 class="font-bold mb-2">Test Performance:</h4>
                        <div class="space-y-2">
                            ${testPerformance.map(t => `
                                <div class="bg-gray-50 p-3 rounded">
                                    <p class="font-medium">${t.title}</p>
                                    <p class="text-sm text-gray-600">Score: ${t.score}/${t.max_score} (${t.percentage.toFixed(1)}%)</p>
                                    <p class="text-xs text-gray-500">${new Date(t.completed_at).toLocaleDateString()}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block font-bold mb-2">Your Feedback:</label>
                        <textarea id="feedback" class="w-full px-3 py-2 border rounded" rows="4" placeholder="Provide feedback (required for rejection)"></textarea>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="closeReviewModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                            Cancel
                        </button>
                        <button onclick="rejectSignoff(${requestId})" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                            <i class="fas fa-times mr-2"></i>Reject
                        </button>
                        <button onclick="approveSignoff(${requestId})" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                            <i class="fas fa-check mr-2"></i>Approve
                        </button>
                    </div>
                `;
                
                document.getElementById('review-content').innerHTML = html;
                document.getElementById('review-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading sign-off details:', error);
                alert('Error loading sign-off details');
            }
        }

        function closeReviewModal() {
            document.getElementById('review-modal').classList.add('hidden');
        }

        async function approveSignoff(requestId) {
            const feedback = document.getElementById('feedback').value;
            
            if (!confirm('Are you sure you want to approve this sign-off?')) return;
            
            try {
                await axios.post(`/api/boss/signoff-requests/${requestId}/approve`, { feedback });
                closeReviewModal();
                alert('Sign-off approved!');
                loadSignoffs();
            } catch (error) {
                console.error('Error approving sign-off:', error);
                alert('Error approving sign-off');
            }
        }

        async function rejectSignoff(requestId) {
            const feedback = document.getElementById('feedback').value;
            
            if (!feedback) {
                alert('Feedback is required for rejection');
                return;
            }
            
            if (!confirm('Are you sure you want to reject this sign-off?')) return;
            
            try {
                await axios.post(`/api/boss/signoff-requests/${requestId}/reject`, { feedback });
                closeReviewModal();
                alert('Sign-off rejected with feedback');
                loadSignoffs();
            } catch (error) {
                console.error('Error rejecting sign-off:', error);
                alert('Error rejecting sign-off');
            }
        }

        async function loadTeam() {
            try {
                const response = await axios.get('/api/boss/team');
                const team = response.data.team;
                
                const html = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Levels</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Points</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Streak</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rank</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${team.map(member => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap font-medium">${member.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${member.email}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${member.levels_completed}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${member.total_points || 0}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="text-orange-500">ðŸ”¥</span> ${member.current_login_streak || 0}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">#${member.rank || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <button onclick="viewProgress(${member.id})" class="text-green-700 hover:text-blue-800">
                                                <i class="fas fa-chart-line mr-1"></i>View Progress
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('team-list').innerHTML = html || '<p class="text-gray-500">No team members</p>';
            } catch (error) {
                console.error('Error loading team:', error);
            }
        }

        async function viewProgress(userId) {
            try {
                const response = await axios.get(`/api/boss/team/${userId}/progress`);
                const { user, progress, recentTests, stats } = response.data;
                
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                            <h2 class="text-2xl font-bold">${user.name}'s Progress</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        
                        <div class="p-6">
                            <!-- Stats Overview -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <div class="text-sm text-gray-600">Total Points</div>
                                    <div class="text-2xl font-bold text-blue-600">${stats?.total_points || 0}</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <div class="text-sm text-gray-600">Current Streak</div>
                                    <div class="text-2xl font-bold text-green-600">${stats?.current_login_streak || 0} days</div>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <div class="text-sm text-gray-600">Longest Streak</div>
                                    <div class="text-2xl font-bold text-purple-600">${stats?.longest_login_streak || 0} days</div>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg">
                                    <div class="text-sm text-gray-600">Last Login</div>
                                    <div class="text-sm font-bold text-orange-600">${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</div>
                                </div>
                            </div>
                            
                            <!-- Level Progress -->
                            <div class="mb-6">
                                <h3 class="text-xl font-bold mb-4">Level Progress</h3>
                                <div class="space-y-3">
                                    ${progress.map(level => `
                                        <div class="border rounded-lg p-4 ${
                                            level.status === 'completed' ? 'bg-green-50 border-green-300' : 
                                            level.status === 'in_progress' ? 'bg-blue-50 border-blue-300' : 
                                            level.status === 'unlocked' ? 'bg-gray-50 border-gray-300' : 
                                            'bg-gray-100 border-gray-200'
                                        }">
                                            <div class="flex justify-between items-center">
                                                <div class="flex-1">
                                                    <div class="font-semibold">${level.title}</div>
                                                    <div class="text-sm text-gray-600">${level.description || ''}</div>
                                                </div>
                                                <div class="ml-4">
                                                    ${level.status === 'completed' ? '<span class="px-3 py-1 bg-green-600 text-white rounded-full text-sm">âœ“ Completed</span>' : 
                                                      level.status === 'in_progress' ? '<span class="px-3 py-1 bg-blue-600 text-white rounded-full text-sm">In Progress</span>' : 
                                                      level.status === 'unlocked' ? '<span class="px-3 py-1 bg-gray-600 text-white rounded-full text-sm">Unlocked</span>' : 
                                                      '<span class="px-3 py-1 bg-gray-400 text-white rounded-full text-sm">Locked</span>'}
                                                </div>
                                            </div>
                                            ${level.completed_at ? `<div class="text-xs text-gray-500 mt-2">Completed: ${new Date(level.completed_at).toLocaleDateString()}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Recent Test Attempts -->
                            <div class="mb-4">
                                <h3 class="text-xl font-bold mb-4">Recent Test Attempts</h3>
                                ${recentTests.length > 0 ? `
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-2 text-left text-sm font-semibold">Test</th>
                                                    <th class="px-4 py-2 text-left text-sm font-semibold">Level</th>
                                                    <th class="px-4 py-2 text-left text-sm font-semibold">Score</th>
                                                    <th class="px-4 py-2 text-left text-sm font-semibold">Result</th>
                                                    <th class="px-4 py-2 text-left text-sm font-semibold">Date</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-200">
                                                ${recentTests.map(test => `
                                                    <tr>
                                                        <td class="px-4 py-2 text-sm">${test.test_title}</td>
                                                        <td class="px-4 py-2 text-sm">${test.level_title}</td>
                                                        <td class="px-4 py-2 text-sm">${test.score}/${test.max_score} (${test.percentage}%)</td>
                                                        <td class="px-4 py-2 text-sm">
                                                            ${test.passed ? '<span class="text-green-600 font-semibold">âœ“ Passed</span>' : '<span class="text-red-600 font-semibold">âœ— Failed</span>'}
                                                        </td>
                                                        <td class="px-4 py-2 text-sm">${new Date(test.completed_at).toLocaleDateString()}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p class="text-gray-500">No test attempts yet</p>'}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading progress:', error);
                alert('Error loading progress details');
            }
        }

        async function loadAnalytics() {
            try {
                const response = await axios.get('/api/boss/analytics');
                const { teamStats, levelCompletion, recentActivity, pendingSignoffs } = response.data;
                
                // Team stats
                document.getElementById('team-stats').innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-gray-600">Total Team Members</p>
                            <p class="text-3xl font-bold">${teamStats.total_members}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Avg Levels Completed</p>
                            <p class="text-3xl font-bold">${(teamStats.avg_levels_completed || 0).toFixed(1)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Avg Points</p>
                            <p class="text-3xl font-bold">${(teamStats.avg_points || 0).toFixed(0)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Avg Streak</p>
                            <p class="text-3xl font-bold">${(teamStats.avg_streak || 0).toFixed(1)} days</p>
                        </div>
                        <div class="pt-4 border-t">
                            <p class="text-sm text-gray-600">Pending Sign-offs</p>
                            <p class="text-3xl font-bold text-yellow-600">${pendingSignoffs}</p>
                        </div>
                    </div>
                `;
                
                // Level completion
                document.getElementById('level-completion').innerHTML = levelCompletion.map(level => `
                    <div class="mb-4">
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium">${level.title}</span>
                            <span class="text-sm">${level.completed_count}/${level.total_members}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="renoir-green h-2.5 rounded-full" 
                                 style="width: ${(level.completed_count / level.total_members * 100)}%"></div>
                        </div>
                    </div>
                `).join('');
                
                // Recent activity
                document.getElementById('recent-activity').innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left">Consultant</th>
                                    <th class="px-4 py-2 text-left">Level</th>
                                    <th class="px-4 py-2 text-left">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentActivity.map(a => `
                                    <tr class="border-b">
                                        <td class="px-4 py-2">${a.consultant_name}</td>
                                        <td class="px-4 py-2">${a.level_title}</td>
                                        <td class="px-4 py-2">${new Date(a.completed_at).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function toggleExportMenu() {
            const menu = document.getElementById('export-menu');
            menu.classList.toggle('hidden');
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('export-menu');
            if (menu && !e.target.closest('[onclick*="exportReport"]') && !e.target.closest('[onclick*="toggleExportMenu"]')) {
                menu.classList.add('hidden');
            }
        });
        
        function generateExcel(data, timestamp) {
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            
            // Prepare data with headers
            const headers = ['Name', 'Email', 'Project', 'Levels Completed', 'Total Points', 'Current Streak', 'Rank', 'League', 'Last Login'];
            const rows = data.map(row => [
                row.name,
                row.email,
                row.project_name || 'N/A',
                row.levels_completed,
                row.total_points || 0,
                row.current_login_streak || 0,
                row.rank || 'N/A',
                row.league || 'N/A',
                row.last_login ? new Date(row.last_login).toLocaleDateString() : 'Never'
            ]);
            
            // Combine headers and data
            const wsData = [headers, ...rows];
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 20 }, // Name
                { wch: 25 }, // Email
                { wch: 20 }, // Project
                { wch: 15 }, // Levels
                { wch: 12 }, // Points
                { wch: 12 }, // Streak
                { wch: 10 }, // Rank
                { wch: 10 }, // League
                { wch: 15 }  // Last Login
            ];
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Team Report');
            
            // Generate Excel file and download
            XLSX.writeFile(wb, `team-report-${timestamp}.xlsx`);
        }

        async function exportReport(format = 'csv') {
            try {
                // Hide menu
                document.getElementById('export-menu').classList.add('hidden');
                
                const response = await axios.get('/api/boss/export/team-report');
                const { csv, data } = response.data;
                const timestamp = new Date().toISOString().split('T')[0];
                
                if (format === 'csv') {
                    // Download CSV
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `team-report-${timestamp}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else if (format === 'excel') {
                    // Load SheetJS library if not already loaded
                    if (typeof XLSX === 'undefined') {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
                        script.onload = () => generateExcel(data, timestamp);
                        document.head.appendChild(script);
                    } else {
                        generateExcel(data, timestamp);
                    }
                } else if (format === 'pdf') {
                    // Generate PDF using browser print
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Team Report - ${timestamp}</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                h1 { color: #7CB342; margin-bottom: 20px; }
                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                th { background-color: #7CB342; color: white; }
                                tr:nth-child(even) { background-color: #f9f9f9; }
                                .header { margin-bottom: 20px; }
                                .timestamp { color: #666; font-size: 14px; }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>The Renoir Academy - Team Report</h1>
                                <p class="timestamp">Generated: ${new Date().toLocaleString()}</p>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Project</th>
                                        <th>Levels</th>
                                        <th>Points</th>
                                        <th>Streak</th>
                                        <th>Rank</th>
                                        <th>League</th>
                                        <th>Last Login</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr>
                                            <td>${row.name}</td>
                                            <td>${row.email}</td>
                                            <td>${row.project_name || 'N/A'}</td>
                                            <td>${row.levels_completed}</td>
                                            <td>${row.total_points || 0}</td>
                                            <td>${row.current_login_streak || 0}</td>
                                            <td>${row.rank || 'N/A'}</td>
                                            <td>${row.league || 'N/A'}</td>
                                            <td>${row.last_login ? new Date(row.last_login).toLocaleDateString() : 'Never'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                    setTimeout(() => {
                        printWindow.print();
                    }, 250);
                }
            } catch (error) {
                console.error('Error exporting report:', error);
                alert('Error exporting report');
            }
        }

        // Initial load
        loadSignoffs();
    </script>
    
    <!-- Copyright Footer -->
    <!-- Developed with Claude Sonnet 4.5, running in GensparkAI -->
    <footer class="text-center py-4 text-xs text-gray-500 bg-gray-50">
        Copyright Â© 2025 Keith Symondson & Renoir / YCP. All rights reserved.
    </footer>
</body>
</html>
